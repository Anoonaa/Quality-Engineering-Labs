<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transactions - FinLab</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <nav class="navbar" role="navigation" aria-label="Main navigation">
    <div class="nav-brand">
      <span class="brand-text">FinLab</span>
    </div>
    <ul class="nav-links">
      <li><a href="index.html" class="nav-link" data-page="home">Home</a></li>
      <li><a href="transactions.html" class="nav-link active" data-page="transactions">Transactions</a></li>
      <li><a href="market.html" class="nav-link" data-page="market">Market</a></li>
      <li><a href="payment.html" class="nav-link" data-page="payment">Payment</a></li>
      <li><a href="login.html" class="nav-link" data-page="login">Login</a></li>
    </ul>
    <div class="nav-user" id="nav-user">
      <span id="nav-username" data-testid="nav-username"></span>
      <button id="nav-logout" data-testid="logout-btn" class="btn btn-sm btn-outline" style="display:none;">Logout</button>
    </div>
  </nav>

  <main class="container">
    <section class="page-header">
      <h1 data-testid="page-title"><i data-lucide="receipt"></i> Transactions</h1>
      <p class="page-desc">Manage your transactions. Great for testing CRUD operations, list rendering, filtering, and state assertions.</p>
    </section>

    <!-- Add Transaction -->
    <div class="transaction-input-row">
      <input type="text" id="txn-desc" data-testid="txn-input" placeholder="Transaction description..." class="input" aria-label="Transaction description" />
      <input type="number" id="txn-amount" data-testid="txn-amount" placeholder="Amount" class="input txn-amount-input" aria-label="Transaction amount" step="0.01" />
      <select id="txn-type" data-testid="txn-type" class="input select txn-type-select" aria-label="Transaction type">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
      <button class="btn btn-primary" data-testid="add-txn-btn" id="add-txn-btn">
        <i data-lucide="plus"></i> Add
      </button>
    </div>

    <!-- Filter -->
    <div class="todo-filters" data-testid="txn-filters">
      <button class="btn btn-filter active" data-filter="all" data-testid="filter-all">All</button>
      <button class="btn btn-filter" data-filter="income" data-testid="filter-income">Income</button>
      <button class="btn btn-filter" data-filter="expense" data-testid="filter-expense">Expense</button>
    </div>

    <!-- Stats -->
    <div class="todo-stats" data-testid="txn-stats">
      <span data-testid="txn-count" id="txn-count">0 transactions</span>
      <span data-testid="txn-balance" id="txn-balance" class="txn-net-balance">Balance: $0.00</span>
    </div>

    <!-- Loading -->
    <div class="loading-state" data-testid="txn-loading" id="txn-loading">
      <i data-lucide="loader" class="spin"></i> Loading transactions...
    </div>

    <!-- Transaction List -->
    <ul class="todo-list" data-testid="txn-list" id="txn-list" role="list"></ul>

    <!-- Empty state -->
    <div class="empty-state" data-testid="empty-state" id="empty-state" style="display:none;">
      <i data-lucide="inbox"></i>
      <p>No transactions to display.</p>
    </div>
  </main>

  <footer class="footer" role="contentinfo">
    <p>&copy; 2026 FinLab. Built for testing purposes.</p>
  </footer>

  <script src="app.js"></script>
  <script>
    let transactions = [];
    let currentFilter = 'all';

    const txnList = document.getElementById('txn-list');
    const txnDesc = document.getElementById('txn-desc');
    const txnAmountInput = document.getElementById('txn-amount');
    const txnType = document.getElementById('txn-type');
    const txnCount = document.getElementById('txn-count');
    const txnBalance = document.getElementById('txn-balance');
    const loading = document.getElementById('txn-loading');
    const emptyState = document.getElementById('empty-state');

    const incomeDescriptions = ['Salary deposit', 'Freelance payment', 'Refund received', 'Dividend income', 'Bonus payout'];
    const expenseDescriptions = ['Grocery shopping', 'Electric bill', 'Coffee shop', 'Subscription fee', 'Restaurant dinner'];

    async function fetchTransactions() {
      loading.style.display = 'flex';
      txnList.style.display = 'none';
      try {
        const res = await fetch('https://jsonplaceholder.typicode.com/todos?_limit=10');
        const todos = await res.json();
        transactions = todos.map((t, i) => ({
          id: t.id,
          description: t.completed ? incomeDescriptions[i % 5] : expenseDescriptions[i % 5],
          amount: parseFloat((Math.random() * 500 + 10).toFixed(2)),
          type: t.completed ? 'income' : 'expense',
          processed: t.completed
        }));
      } catch (e) {
        transactions = [];
      }
      loading.style.display = 'none';
      txnList.style.display = 'block';
      renderTransactions();
    }

    function renderTransactions() {
      const filtered = transactions.filter(t => {
        if (currentFilter === 'income') return t.type === 'income';
        if (currentFilter === 'expense') return t.type === 'expense';
        return true;
      });

      txnList.innerHTML = '';
      filtered.forEach(txn => {
        const li = document.createElement('li');
        li.className = 'todo-item' + (txn.processed ? ' completed' : '');
        li.setAttribute('data-testid', `txn-item-${txn.id}`);
        li.setAttribute('role', 'listitem');
        const sign = txn.type === 'income' ? '+' : '-';
        const amountClass = txn.type === 'income' ? 'txn-amount-positive' : 'txn-amount-negative';
        li.innerHTML = `
          <label class="todo-label">
            <input type="checkbox" ${txn.processed ? 'checked' : ''} 
              data-testid="txn-checkbox-${txn.id}" 
              aria-label="Mark ${txn.description} as processed"
              class="todo-checkbox" />
            <span class="todo-text" data-testid="txn-text-${txn.id}">${txn.description}</span>
          </label>
          <span class="txn-amount ${amountClass}" data-testid="txn-value-${txn.id}">${sign}$${txn.amount.toFixed(2)}</span>
          <button class="btn btn-icon btn-danger-icon" data-testid="delete-txn-${txn.id}" aria-label="Delete transaction">
            <i data-lucide="trash-2"></i>
          </button>
        `;
        li.querySelector('input[type="checkbox"]').addEventListener('change', () => {
          txn.processed = !txn.processed;
          renderTransactions();
        });
        li.querySelector('button').addEventListener('click', () => {
          transactions = transactions.filter(t => t.id !== txn.id);
          renderTransactions();
        });
        txnList.appendChild(li);
      });

      lucide.createIcons();

      const total = transactions.length;
      const income = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
      const expense = transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
      const net = income - expense;
      txnCount.textContent = `${total} transaction${total !== 1 ? 's' : ''}`;
      txnBalance.textContent = `Balance: ${net >= 0 ? '' : '-'}$${Math.abs(net).toFixed(2)}`;
      txnBalance.className = net >= 0 ? 'txn-net-balance txn-amount-positive' : 'txn-net-balance txn-amount-negative';

      emptyState.style.display = filtered.length === 0 ? 'flex' : 'none';
      txnList.style.display = filtered.length === 0 ? 'none' : 'block';
    }

    // Add transaction
    document.getElementById('add-txn-btn').addEventListener('click', () => {
      const desc = txnDesc.value.trim();
      const amount = parseFloat(txnAmountInput.value);
      const type = txnType.value;
      if (!desc || isNaN(amount) || amount <= 0) return;
      const newTxn = { id: Date.now(), description: desc, amount, type, processed: false };
      transactions.unshift(newTxn);
      txnDesc.value = '';
      txnAmountInput.value = '';
      renderTransactions();
    });

    txnDesc.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('add-txn-btn').click();
    });

    // Filters
    document.querySelectorAll('.btn-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderTransactions();
      });
    });

    fetchTransactions();
  </script>
</body>
</html>
